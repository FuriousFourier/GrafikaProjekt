<html>
  <head>
    <title>Wymodelowanie uproszczonej wersji mechanizmu, np. ruchomego modelu silnika tłokowego</title>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <script src="lib/jquery-1.9.1/jquery-1.9.1.js"></script>
      <script src="lib/three.js.r58/three.js"></script>
      <script src="lib/requestAnimationFrame/RequestAnimationFrame.js"></script>
  </head>
  <body>

    <canvas id="webglcanvas" style="border: none;" width="500" height="500" background="red"></canvas>

    <script type="text/javascript">
        var renderer = null,
            scene = null,
            camera = null,
            myTime = Date.now(),
            period = 5000,
            objects = {};

        function animate() {

            for (var key in objects) {
                objects[key].rotation.z = (Date.now() - myTime) / period * 2 * Math.PI;
                objects[key].rotation.y = (Date.now() - myTime) / period * 2 * Math.PI / 2;
            }
          /**  var now = Date.now();
            var deltat = now - currentTime;
            currentTime = now;
            var fract = deltat / duration;
            var angle = Math.PI * 2 * fract;


            cylinderGeometry.rotation.y += angle;

            cylinderGeometry.rotation.z += angle;
            cylinderGeometry.rotation.x += angle; **/
        }
        function rotateScene(deltax)
        {
            root.rotation.y += deltax / 100;
            $("#rotation").html("obrót: 0," + root.rotation.y.toFixed(2) + ",0");
        }

        function scaleScene(scale)
        {
            root.scale.set(scale, scale, scale);
            $("#scale").html("skala: " + scale);
        }

        var mouseDown = false,
            pageX = 0;

        function onMouseMove(evt)
        {
            if (!mouseDown)
                return;

            evt.preventDefault();

            var deltax = evt.pageX - pageX;
            pageX = evt.pageX;
            rotateScene(deltax);
        }

        function onMouseDown(evt)
        {
            evt.preventDefault();

            mouseDown = true;
            pageX = evt.pageX;
        }

        function onMouseUp(evt)
        {
            evt.preventDefault();

            mouseDown = false;
        }

        function addMouseHandler(canvas)
        {
            canvas.addEventListener( 'mousemove',
                function(e) { onMouseMove(e); }, false );
            canvas.addEventListener( 'mousedown',
                function(e) { onMouseDown(e); }, false );
            canvas.addEventListener( 'mouseup',
                function(e) { onMouseUp(e); }, false );
        }
        

        function doThings() {
            requestAnimationFrame(function() { doThings(); });

            // Renderuje scenę
            renderer.render( scene, camera );

            // Obraca kostką w następnej klatce
            animate();

        }

        $(document).ready(
            function() {

                var canvas = document.getElementById("webglcanvas");
                renderer = new THREE.WebGLRenderer( { canvas: canvas, antialias: true } );
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setClearColor(0xDED5D0, 1);
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera( 45, canvas.width / canvas.height, 1, 4000 );
                scene.add(camera);
                camera.position.z = 5;

                document.body.appendChild(renderer.domElement);

                var textureFile = "images/foo.jpg";
                var texture = THREE.ImageUtils.loadTexture(textureFile);

                var cylinderGeometry = new THREE.CylinderGeometry(.4,.4,2,32,1, true);
                var material = new THREE.MeshPhongMaterial({color: 0xffeedd, side:THREE.DoubleSide, map: texture});
                objects["cylinder"] = new THREE.Mesh(cylinderGeometry, material);

                // create a point light
                var light = new THREE.PointLight();

                // set its position
                light.position.x = 0;
                light.position.y = 0;
                light.position.z = 10;

                // add to the scene
                scene.add(light);

                for (var key in objects) {
                    scene.add(objects[key]);
                }
                doThings();

                // dodaje obsługę myszy, aby można było obracać scenę
                addMouseHandler(canvas);
            }
        );

    </script>
  </body>
</html>
